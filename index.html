<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Night Shelf — 書評SNS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg: #05030c;
      --panel: rgba(255, 255, 255, 0.04);
      --panel-strong: rgba(13, 12, 35, 0.75);
      --text: #f6f7fb;
      --muted: rgba(255, 255, 255, 0.7);
      --accent: #8b7bff;
      --accent-2: #ffce57;
      --border: rgba(255, 255, 255, 0.12);
      --comment-bg: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Noto Sans JP", system-ui, sans-serif;
      background: radial-gradient(circle at top, rgba(139, 123, 255, 0.18), transparent 55%),
                  radial-gradient(circle at 20% 20%, rgba(255, 206, 87, 0.2), transparent 50%),
                  var(--bg);
      color: var(--text);
      padding: clamp(1.5rem, 3vw, 3rem);
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }

    .hero {
      background: var(--panel-strong);
      border: 1px solid var(--border);
      border-radius: 32px;
      padding: clamp(2rem, 4vw, 3.5rem);
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 70% 0%, rgba(255, 255, 255, 0.15), transparent 60%);
      pointer-events: none;
    }

    .hero-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.85rem;
      background: rgba(255, 255, 255, 0.08);
      color: var(--muted);
      margin-bottom: 1rem;
      position: relative;
      z-index: 1;
    }

    .hero h1 {
      position: relative;
      z-index: 1;
      font-family: "Space Grotesk", "Noto Sans JP", sans-serif;
      font-size: clamp(2.8rem, 6vw, 4.5rem);
      margin: 0;
    }

    .hero h1 span {
      color: var(--accent-2);
    }

    .hero p {
      position: relative;
      z-index: 1;
      max-width: 640px;
      font-size: 1.1rem;
      color: var(--muted);
      line-height: 1.8;
      margin: 1rem 0 1.5rem;
    }

    .policies {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .policy-card {
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.18);
      padding: 1rem 1.25rem;
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.6;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 2rem;
    }

    .panel {
      background: rgba(6, 8, 18, 0.8);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: clamp(1.5rem, 3vw, 2.5rem);
      position: relative;
      overflow: hidden;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .tab-shell {
      display: grid;
      gap: 1.5rem;
    }

    .tab-radio {
      position: absolute;
      width: 1px;
      height: 1px;
      left: -9999px;
      opacity: 0;
      pointer-events: none;
    }

    .tab-nav {
      display: flex;
      gap: 0.65rem;
      padding: 0.9rem;
      align-items: center;
    }

    .tab-nav label {
      flex: 1;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.03);
      color: var(--muted);
      font-size: 1rem;
      font-weight: 600;
      font-family: "Space Grotesk", "Noto Sans JP", sans-serif;
      padding: 0.85rem 1rem;
      cursor: pointer;
      transition: border-color 160ms ease, color 160ms ease, background 160ms ease;
      text-align: center;
      user-select: none;
    }

    .tab-nav label:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 3px;
    }

    #tab-sns-control:checked ~ .tab-nav label[for="tab-sns-control"],
    #tab-ranking-control:checked ~ .tab-nav label[for="tab-ranking-control"],
    #tab-mypage-control:checked ~ .tab-nav label[for="tab-mypage-control"] {
      color: #05030c;
      border-color: transparent;
      background: linear-gradient(120deg, #ffce57, #8b7bff);
    }

    .idea-button {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: 52px;
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 160ms ease, border-color 160ms ease, background 160ms ease;
      backdrop-filter: blur(8px);
      z-index: 2;
    }

    .idea-button svg {
      width: 24px;
      height: 24px;
      fill: none;
      stroke: var(--accent-2);
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .idea-button[aria-expanded="true"] {
      transform: translateY(-2px);
      border-color: var(--accent-2);
      background: rgba(255, 255, 255, 0.18);
    }

    .idea-button:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 3px;
    }

    .idea-panel {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      width: min(360px, calc(100% - 2rem));
      max-height: 70vh;
      display: grid;
      gap: 1.25rem;
      padding: 1.5rem;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(6, 8, 18, 0.95);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.45);
      overflow-y: auto;
      z-index: 3;
    }

    .idea-panel[hidden] {
      display: none;
    }

    .idea-panel .feature-grid {
      grid-template-columns: 1fr;
    }

    .view {
      display: none;
      gap: 2rem;
    }

    #tab-sns-control:checked ~ #view-sns,
    #tab-ranking-control:checked ~ #view-ranking,
    #tab-mypage-control:checked ~ #view-mypage {
      display: grid;
    }

    .section-heading {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 1.5rem;
    }

    .section-heading span {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .section-heading h2 {
      margin: 0;
      font-size: 1.8rem;
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.25rem;
    }

    .feature-card {
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      padding: 1.25rem;
      display: grid;
      gap: 0.75rem;
    }

    .feature-card strong {
      font-size: 1.05rem;
    }

    .feature-card p {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .feature-card em {
      font-style: normal;
      color: var(--accent-2);
      font-size: 0.9rem;
      letter-spacing: 0.08em;
    }

    .ranking-panel {
      background: linear-gradient(135deg, rgba(139, 123, 255, 0.12), rgba(5, 3, 12, 0.9));
    }

    .ranking-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.85rem;
    }

    .ranking-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.2rem;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.2);
    }

    .rank-index {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
    }

    .ranking-item strong {
      display: block;
      font-size: 1.05rem;
    }

    .ranking-item span {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .trend-chip {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .trend-chip.up {
      color: #0fd976;
      border-color: #0fd976;
    }

    .trend-chip.new {
      color: var(--accent-2);
      border-color: var(--accent-2);
    }

    .mypage-intro {
      color: var(--muted);
      line-height: 1.7;
      margin: 0 0 1.25rem;
    }

    .personal-note {
      border-left: 3px solid var(--accent-2);
      padding-left: 1rem;
    }

    .mypage-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .input-panel {
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.25);
      padding: 1.25rem;
      display: grid;
      gap: 0.75rem;
    }

    .input-panel h3 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.05em;
    }

    .input-panel label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .input-panel input,
    .input-panel textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font: inherit;
      padding: 0.7rem 0.85rem;
      resize: none;
    }

    .input-panel textarea {
      min-height: 100px;
    }

    .input-panel button {
      margin-top: 0.5rem;
      justify-self: start;
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
      color: #05030c;
      background: linear-gradient(120deg, #ffce57, #8b7bff);
      cursor: pointer;
    }

    .inline-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .form-helper {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .mypage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .stat-card {
      border-radius: 18px;
      padding: 1.25rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      display: grid;
      gap: 0.4rem;
    }

    .stat-card small {
      font-size: 0.75rem;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .stat-card strong {
      font-size: 1.8rem;
      font-family: "Space Grotesk", sans-serif;
    }

    .stat-card span {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .shelf-list {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .shelf-card {
      display: grid;
      gap: 0.5rem;
      padding: 1rem;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.25);
    }

    .shelf-card h3 {
      margin: 0;
      font-size: 1rem;
    }

    .shelf-progress {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
    }

    .shelf-progress span {
      display: block;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
    }

    .shelf-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .empty-state {
      border: 1px dashed rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 1rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .shelf-note {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .panel h2 {
      margin: 0 0 1rem;
      font-size: 1.4rem;
      font-family: "Space Grotesk", "Noto Sans JP", sans-serif;
      letter-spacing: 0.02em;
    }

    .panel small {
      color: var(--muted);
    }

    .book-search {
      margin-bottom: 1rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      display: grid;
      gap: 0.75rem;
    }

    .book-search label {
      display: grid;
      gap: 0.35rem;
    }

    .book-search input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 0.75rem 1.1rem;
      background: rgba(0, 0, 0, 0.3);
      color: var(--text);
      font: inherit;
    }

    .search-results {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    .search-results button {
      width: 100%;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      padding: 0.75rem 1rem;
      cursor: pointer;
    }

    .search-results button strong {
      display: block;
      font-size: 1rem;
    }

    .search-results button span {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .search-status {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .feed {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .review-card {
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.03);
      padding: 1.5rem;
      display: grid;
      gap: 0.85rem;
    }

    .review-card header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 0.75rem;
      justify-content: space-between;
    }

    .review-card h3 {
      margin: 0;
      font-size: 1.15rem;
    }

    .alias {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .stars {
      position: relative;
      font-size: 1.1rem;
      letter-spacing: 0.15em;
      color: rgba(255, 255, 255, 0.25);
      font-family: "Space Grotesk", sans-serif;
    }

    .stars span {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--fill, 100%);
      color: var(--accent-2);
      overflow: hidden;
      white-space: nowrap;
      pointer-events: none;
    }

    .review-card p {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag {
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--muted);
    }

    .comments {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: var(--comment-bg);
      padding: 1rem;
      display: grid;
      gap: 0.75rem;
    }

    .comments h4 {
      margin: 0;
      font-size: 1rem;
    }

    .comment-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.65rem;
    }

    .comment-list li {
      padding: 0.65rem 0.85rem;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(0, 0, 0, 0.15);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .comment-list strong {
      display: block;
      color: var(--accent-2);
      margin-bottom: 0.2rem;
    }

    .comment-form {
      display: grid;
      gap: 0.65rem;
    }

    .comment-form label {
      display: grid;
      gap: 0.35rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .comment-form input,
    .comment-form textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.15);
      color: var(--text);
      font: inherit;
      padding: 0.65rem 0.85rem;
      resize: none;
    }

    .comment-form textarea {
      min-height: 90px;
    }

    .comment-form button {
      justify-self: start;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
      color: #05030c;
      background: linear-gradient(120deg, #ffce57, #8b7bff);
      cursor: pointer;
    }

    .tag-input {
      display: grid;
      gap: 0.75rem;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
    }

    .selected-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag-chip {
      border-radius: 999px;
      padding: 0.35rem 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
    }

    .tag-chip.selected {
      background: rgba(255, 206, 87, 0.15);
      border-color: var(--accent-2);
      color: var(--accent-2);
    }

    .tag-chip button {
      border: none;
      background: rgba(0, 0, 0, 0.2);
      color: inherit;
      cursor: pointer;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      line-height: 1;
    }

    .tag-empty {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .tag-custom {
      display: flex;
      gap: 0.5rem;
    }

    .tag-custom input {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font: inherit;
      padding: 0.65rem 0.85rem;
    }

    .tag-custom button {
      border-radius: 12px;
      border: 1px solid transparent;
      background: linear-gradient(120deg, #ffce57, #8b7bff);
      color: #05030c;
      font-weight: 600;
      cursor: pointer;
      padding: 0.65rem 0.95rem;
      font-family: "Space Grotesk", sans-serif;
    }

    .tag-clear {
      justify-self: start;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: transparent;
      color: var(--muted);
      font-size: 0.85rem;
      padding: 0.35rem 0.8rem;
      cursor: pointer;
    }

    form {
      display: grid;
      gap: 1rem;
    }

    label span {
      display: inline-block;
      margin-bottom: 0.35rem;
      font-size: 0.95rem;
      color: var(--muted);
    }

    input,
    textarea {
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font: inherit;
      padding: 0.85rem 1rem;
      resize: none;
    }

    textarea {
      min-height: 140px;
    }

    .rating-control {
      display: flex;
      gap: 0.5rem;
    }

    .rating-control button {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.03);
      color: rgba(255, 255, 255, 0.4);
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 160ms ease, border-color 160ms ease, color 160ms ease;
    }

    .rating-control button.active {
      color: var(--accent-2);
      border-color: var(--accent-2);
      transform: translateY(-3px);
      background: rgba(255, 206, 87, 0.08);
    }

    .rating-control button:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 3px;
    }

    .submit {
      border: none;
      border-radius: 24px;
      padding: 0.95rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
      color: #05030c;
      background: linear-gradient(120deg, #ffce57, #8b7bff);
      cursor: pointer;
      transition: transform 160ms ease;
    }

    .submit:hover {
      transform: translateY(-2px);
    }

    .helper {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: -0.5rem;
    }

    .form-status {
      min-height: 1.2rem;
      font-size: 0.9rem;
      color: var(--accent-2);
    }

    footer {
      text-align: center;
      padding: 1.5rem 0 2rem;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.55);
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }

      .hero {
        border-radius: 24px;
        padding-top: 4.5rem;
      }

      .idea-button {
        top: 1rem;
        right: 1rem;
        width: 46px;
        height: 46px;
      }

      .idea-panel {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        width: auto;
        max-height: 80vh;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <button type="button" class="idea-button" id="idea-toggle" aria-expanded="false" aria-controls="idea-panel">
        <span class="sr-only">Night Shelfでできる3つのことを表示</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 18h6" />
          <path d="M10 22h4" />
          <path d="M7 8a5 5 0 1 1 10 0c0 2.22-1.2 3.4-2.24 4.5-.83.86-1.4 1.82-1.63 2.95a.5.5 0 0 1-.49.4h-1.28a.5.5 0 0 1-.48-.37c-.28-1.18-.88-2.16-1.72-3.01C8.08 11.45 7 10.2 7 8Z" />
        </svg>
      </button>
      <div class="idea-panel" id="idea-panel" role="dialog" aria-labelledby="idea-panel-title" hidden>
        <div class="section-heading">
          <span>書評SNS</span>
          <h2 id="idea-panel-title">Night Shelfでできる3つのこと</h2>
        </div>
        <div class="feature-grid">
          <article class="feature-card">
            <em>匿名×一次ソース</em>
            <strong>書誌情報付きの短評投稿</strong>
            <p>ISBNでひも付けられたレビューだけが投稿され、推測や引用不明の噂は流れません。一次情報を大事にする人のためのタイムラインです。</p>
          </article>
          <article class="feature-card">
            <em>対話で磨く</em>
            <strong>コメントのやり取り</strong>
            <p>レビューごとに根拠を添えたコメントが集まり、誤情報を見つけたらすぐに指摘できます。納得感のある議論だけが残ります。</p>
          </article>
          <article class="feature-card">
            <em>テーマで追う</em>
            <strong>タグベースの棚づくり</strong>
            <p>#歴史、#翻訳もの など自分の視点で並べたタグをフォローするだけで、興味の近い人の書評が集まります。</p>
          </article>
        </div>
      </div>
      <div class="hero-label">Night Shelf / Review SNS</div>
      <h1>匿名でつなぐ<span>書評</span>コミュニティ</h1>
      <p>Night Shelfは、読んだ人の一次体験だけを共有するスペース。推測や引用元不明の情報は流さず、読了の温度を事実とともに残していきます。</p>
      <div class="policies">
        <div class="policy-card">引用・要約は必ず原著を確認してから投稿。根拠のない断言や噂話は書かないこと。</div>
        <div class="policy-card">書誌情報はISBNなど一次ソースでセルフチェック。誤情報を見つけたらコメントで貢献しよう。</div>
        <div class="policy-card">AI生成文や広告は不可。1レビュー1感想というシンプルなルールを守ります。</div>
      </div>
    </section>

    <section class="tab-shell">
      <input type="radio" name="view-tab" id="tab-sns-control" class="tab-radio" checked />
      <input type="radio" name="view-tab" id="tab-ranking-control" class="tab-radio" />
      <input type="radio" name="view-tab" id="tab-mypage-control" class="tab-radio" />

      <nav class="panel tab-nav" role="tablist" aria-label="Night Shelfのパート切り替え">
        <label id="tab-sns-label" for="tab-sns-control" data-view-label="sns" role="tab" aria-controls="view-sns" aria-selected="true" tabindex="0">書評SNS</label>
        <label id="tab-ranking-label" for="tab-ranking-control" data-view-label="ranking" role="tab" aria-controls="view-ranking" aria-selected="false" tabindex="0">ランキング</label>
        <label id="tab-mypage-label" for="tab-mypage-control" data-view-label="mypage" role="tab" aria-controls="view-mypage" aria-selected="false" tabindex="0">マイページ</label>
      </nav>

      <div class="view" data-view-panel="sns" id="view-sns" role="tabpanel" aria-labelledby="tab-sns-label">
        <div class="grid">
          <section class="panel">
            <h2>最新レビュー</h2>
            <small>※ 誤情報を見つけた場合はコメント欄で根拠を添えて知らせてください。</small>
            <div id="review-feed" class="feed" aria-live="polite"></div>
          </section>

          <section class="panel">
            <h2>レビューを追加</h2>
            <form id="review-form">
              <div class="book-search">
                <label>
                  <span>まず書名を検索して選択してください *</span>
                  <input type="search" id="book-search" placeholder="例: サピエンス全史" autocomplete="off" />
                </label>
                <ul id="search-results" class="search-results" aria-live="polite"></ul>
                <p id="search-status" class="search-status"></p>
              </div>
              <label>
                <span>本のタイトル *</span>
                <input type="text" name="title" id="book-title" placeholder="書名検索から自動入力" required readonly />
              </label>
              <label>
                <span>ハンドルネーム (任意)</span>
                <input type="text" name="alias" id="book-alias" placeholder="未入力なら匿名になります" />
              </label>
              <label>
                <span>星評価 (5段階) *</span>
                <div class="rating-control" role="radiogroup" aria-label="星評価">
                  <button type="button" data-rating-button="1" aria-label="1星">★</button>
                  <button type="button" data-rating-button="2" aria-label="2星">★</button>
                  <button type="button" data-rating-button="3" aria-label="3星">★</button>
                  <button type="button" data-rating-button="4" aria-label="4星">★</button>
                  <button type="button" data-rating-button="5" aria-label="5星">★</button>
                </div>
            </label>
            <label>
              <span>コメント *</span>
              <textarea name="comment" id="book-comment" placeholder="本当に心を動かしたポイントを書いてください" required></textarea>
            </label>
            <label>
              <span>タグ (任意)</span>
              <div class="tag-input">
                <div>
                  <small>選択中</small>
                  <div class="selected-tags" id="selected-tags"></div>
                </div>
                <div class="tag-custom">
                  <input type="text" id="tag-custom-input" placeholder="#カスタムタグを入力" />
                  <button type="button" id="tag-add-button">追加</button>
                </div>
                <button type="button" class="tag-clear" id="tag-clear-button">すべて削除</button>
                <p class="form-helper" id="tag-helper">タグをクリックすると削除できます。自由にハッシュタグを追加してください。</p>
              </div>
            </label>
            <button class="submit" type="submit">レビューを投稿</button>
            <p class="helper">※ 書誌情報に誤りがあった場合はコミュニティの判断で非公開になることがあります。</p>
            <div id="form-status" class="form-status" aria-live="polite"></div>
          </form>
        </section>
        </div>
      </div>

      <div class="view" data-view-panel="ranking" id="view-ranking" role="tabpanel" aria-labelledby="tab-ranking-label">
        <section class="panel ranking-panel">
          <div class="section-heading">
            <span>ランキング</span>
            <h2>いま注目されている本</h2>
          </div>
          <ol class="ranking-list">
            <li class="ranking-item">
              <div class="rank-index">1</div>
              <div>
                <strong>サピエンス全史</strong>
                <span>週内レビュー 42件 / 平均4.8</span>
              </div>
              <div class="trend-chip up">+5</div>
            </li>
            <li class="ranking-item">
              <div class="rank-index">2</div>
              <div>
                <strong>罪と罰</strong>
                <span>週内レビュー 35件 / 平均4.9</span>
              </div>
              <div class="trend-chip up">+2</div>
            </li>
            <li class="ranking-item">
              <div class="rank-index">3</div>
              <div>
                <strong>ハチドリのひとしずく</strong>
                <span>週内レビュー 29件 / 平均4.2</span>
              </div>
              <div class="trend-chip new">NEW</div>
            </li>
            <li class="ranking-item">
              <div class="rank-index">4</div>
              <div>
                <strong>金閣寺</strong>
                <span>週内レビュー 24件 / 平均4.5</span>
              </div>
              <div class="trend-chip">=</div>
            </li>
          </ol>
        </section>
      </div>

      <div class="view" data-view-panel="mypage" id="view-mypage" role="tabpanel" aria-labelledby="tab-mypage-label">
        <section class="panel mypage-panel">
          <div class="section-heading">
            <span>マイページ</span>
            <h2>自分のペースで棚を育てる</h2>
          </div>
          <p class="mypage-intro personal-note" id="profile-note">まだメモは登録されていません。今日の読書テーマを書き残してみませんか？</p>
          <div class="mypage-actions">
            <form class="input-panel" id="note-form">
              <h3>今日のメモ</h3>
              <label>
                <span>気になるテーマや気分</span>
                <textarea id="note-input" placeholder="例: 旅エッセイと翻訳詩を行き来したい"></textarea>
              </label>
              <button type="submit">メモを更新</button>
              <p class="form-helper" id="note-status" aria-live="polite"></p>
            </form>
            <form class="input-panel" id="stat-form">
              <h3>自分の指標を追加</h3>
              <label>
                <span>指標タイトル *</span>
                <input type="text" id="stat-label" placeholder="例: 読書連続日数" required />
              </label>
              <div class="inline-inputs">
                <label>
                  <span>値 *</span>
                  <input type="number" id="stat-value" min="0" placeholder="例: 12" required />
                </label>
                <label>
                  <span>一言メモ (任意)</span>
                  <input type="text" id="stat-note" placeholder="例: 夜更かし2日め" />
                </label>
              </div>
              <button type="submit">指標を保存</button>
              <p class="form-helper" id="stat-status" aria-live="polite"></p>
            </form>
            <form class="input-panel" id="shelf-form">
              <h3>自分だけの本棚</h3>
              <label>
                <span>本棚タイトル *</span>
                <input type="text" id="shelf-title" placeholder="例: 深夜に読み返すエッセイ" required />
              </label>
              <div class="inline-inputs">
                <label>
                  <span>登録冊数 *</span>
                  <input type="number" id="shelf-total" min="0" placeholder="例: 12" required />
                </label>
                <label>
                  <span>レビュー済み冊数 *</span>
                  <input type="number" id="shelf-reviewed" min="0" placeholder="例: 4" required />
                </label>
              </div>
              <label>
                <span>メモ (任意)</span>
                <textarea id="shelf-note" placeholder="進捗や気になったポイントを書き残せます"></textarea>
              </label>
              <button type="submit">本棚を追加</button>
              <p class="form-helper" id="shelf-status" aria-live="polite"></p>
            </form>
          </div>
          <div class="mypage-grid" id="personal-stats"></div>
          <div class="shelf-list" id="personal-shelves"></div>
        </section>
      </div>
    </section>

    <footer>© <span id="footer-year">2024</span> Night Shelf — 読んだ人が責任を持って語る書評SNS</footer>
  </div>

  <script>
    const form = document.getElementById('review-form');
    const statusEl = document.getElementById('form-status');
    const feed = document.getElementById('review-feed');
    const ratingButtons = Array.from(document.querySelectorAll('[data-rating-button]'));
    const searchInput = document.getElementById('book-search');
    const searchResults = document.getElementById('search-results');
    const searchStatus = document.getElementById('search-status');
    const titleInput = document.getElementById('book-title');
    const tabRadios = Array.from(document.querySelectorAll('.tab-radio'));
    const tabLabels = Array.from(document.querySelectorAll('[data-view-label]'));
    const ideaToggle = document.getElementById('idea-toggle');
    const ideaPanel = document.getElementById('idea-panel');
    const noteForm = document.getElementById('note-form');
    const statForm = document.getElementById('stat-form');
    const shelfForm = document.getElementById('shelf-form');
    const noteDisplay = document.getElementById('profile-note');
    const statBoard = document.getElementById('personal-stats');
    const shelfBoard = document.getElementById('personal-shelves');
    const noteStatus = document.getElementById('note-status');
    const statStatus = document.getElementById('stat-status');
    const shelfStatus = document.getElementById('shelf-status');
    const selectedTagsEl = document.getElementById('selected-tags');
    const tagCustomInput = document.getElementById('tag-custom-input');
    const tagAddButton = document.getElementById('tag-add-button');
    const tagClearButton = document.getElementById('tag-clear-button');
    let currentRating = 0;
    let selectedBook = null;
    let userNote = '';
    let selectedTags = [];
    const personalStats = [];
    const personalShelves = [];

    const localCatalog = [
      {
        id: '9784309226710',
        title: 'サピエンス全史',
        author: 'ユヴァル・ノア・ハラリ',
        publisher: '河出書房新社'
      },
      {
        id: '9784103132125',
        title: '金閣寺',
        author: '三島由紀夫',
        publisher: '新潮社'
      },
      {
        id: '9784102020133',
        title: '罪と罰',
        author: 'フョードル・ドストエフスキー',
        publisher: '新潮社'
      },
      {
        id: '9784103534226',
        title: 'ノルウェイの森',
        author: '村上春樹',
        publisher: '講談社'
      },
      {
        id: '9784000265861',
        title: '1Q84',
        author: '村上春樹',
        publisher: '新潮社'
      },
      {
        id: '9784101104216',
        title: '人間失格',
        author: '太宰治',
        publisher: '新潮社'
      }
    ];

    let searchAbortController = null;

    function resetSearchState() {
      selectedBook = null;
      if (titleInput) titleInput.value = '';
      if (searchInput) searchInput.value = '';
      if (searchResults) searchResults.innerHTML = '';
      if (searchStatus) searchStatus.textContent = '書名を入力すると出版社・著者付きの候補が表示されます。';
    }

    function createSearchListItem(book) {
      const item = document.createElement('li');
      const button = document.createElement('button');
      button.type = 'button';
      button.dataset.bookId = book.id || book.isbn || book.title;
      button.dataset.bookTitle = book.title || '';
      button.dataset.bookAuthor = book.author || '';
      button.dataset.bookPublisher = book.publisher || '';
      button.innerHTML = `<strong>${book.title}</strong><span>${book.author || '著者情報なし'} / ${book.publisher || '出版社不明'}</span>`;
      item.appendChild(button);
      return item;
    }

    function renderSelectedTags() {
      if (!selectedTagsEl) return;
      selectedTagsEl.innerHTML = '';
      if (selectedTags.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'tag-empty';
        empty.textContent = 'まだタグは選択されていません。候補をクリックして追加してください。';
        selectedTagsEl.appendChild(empty);
        return;
      }
      selectedTags.forEach(tag => {
        const chip = document.createElement('div');
        chip.className = 'tag-chip selected';
        chip.textContent = tag;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', `${tag}を削除`);
        removeBtn.textContent = '×';
        removeBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          selectedTags = selectedTags.filter(entry => entry !== tag);
          renderSelectedTags();
        });
        chip.appendChild(removeBtn);
        chip.addEventListener('click', (event) => {
          if (event.target === removeBtn) return;
          selectedTags = selectedTags.filter(entry => entry !== tag);
          renderSelectedTags();
        });
        selectedTagsEl.appendChild(chip);
      });
    }

    function renderSearchResults(list) {
      if (!searchResults) return;
      searchResults.innerHTML = '';
      list.forEach(book => {
        searchResults.appendChild(createSearchListItem(book));
      });
    }

    function filterLocalCatalog(keyword) {
      const normalized = keyword.toLowerCase();
      return localCatalog.filter(book => {
        const target = `${book.title}${book.author}${book.publisher}`.toLowerCase();
        return target.includes(normalized);
      });
    }

    async function fetchBooksFromApi(keyword) {
      if (searchAbortController) {
        searchAbortController.abort();
      }
      searchAbortController = new AbortController();
      const endpoint = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(keyword)}&maxResults=6&printType=books`;
      const response = await fetch(endpoint, { signal: searchAbortController.signal });
      if (!response.ok) {
        throw new Error('検索に失敗しました');
      }
      const data = await response.json();
      const items = (data.items || []).map(item => {
        const info = item.volumeInfo || {};
        const identifiers = info.industryIdentifiers || [];
        const isbn = identifiers.find(id => id.type && id.identifier)?.identifier || item.id;
        return {
          id: isbn,
          title: info.title || 'タイトル不明',
          author: Array.isArray(info.authors) ? info.authors.join(' / ') : '著者情報なし',
          publisher: info.publisher || '出版社不明'
        };
      }).filter(entry => entry.title);
      return items;
    }

    async function handleBookSearch(keyword) {
      if (!searchResults) return;
      const normalized = keyword.trim();
      selectedBook = null;
      if (titleInput) titleInput.value = '';
      searchResults.innerHTML = '';

      if (!normalized) {
        searchStatus.textContent = '書名を入力すると出版社・著者付きの候補が表示されます。';
        selectedTags = [];
        renderSelectedTags();
        return;
      }

      if (normalized.length < 2) {
        searchStatus.textContent = 'あと1文字以上入力すると検索できます。';
        return;
      }

      searchStatus.textContent = '検索中です...';
      try {
        const remoteResults = await fetchBooksFromApi(normalized);
        if (remoteResults.length > 0) {
          renderSearchResults(remoteResults);
          searchStatus.textContent = `${remoteResults.length}件ヒットしました。タイトルをクリックして確定してください。`;
          return;
        }

        const fallback = filterLocalCatalog(normalized);
        if (fallback.length > 0) {
          renderSearchResults(fallback);
          searchStatus.textContent = `API結果なし。手元データから${fallback.length}件ヒットしました。`;
          return;
        }

        searchStatus.textContent = '一致する書籍が見つかりませんでした。別のキーワードを試してください。';
      } catch (error) {
        if (error.name === 'AbortError') return;
        const fallback = filterLocalCatalog(normalized);
        if (fallback.length > 0) {
          renderSearchResults(fallback);
          searchStatus.textContent = `オンライン検索に失敗しました。手元データから${fallback.length}件ヒットしました。`;
        } else {
          searchStatus.textContent = '検索に失敗しました。ネットワーク状態を確認のうえ、再度お試しください。';
        }
      }
    }

    if (searchInput) {
      searchInput.addEventListener('input', (event) => {
        handleBookSearch(event.target.value);
      });
    }

    if (searchResults) {
      searchResults.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-book-id]');
        if (!button) return;
        const book = {
          id: button.dataset.bookId,
          title: button.dataset.bookTitle,
          author: button.dataset.bookAuthor,
          publisher: button.dataset.bookPublisher
        };
        if (!book.title) return;
        selectedBook = book;
        titleInput.value = book.title;
        searchInput.value = book.title;
        searchResults.innerHTML = '';
        searchStatus.textContent = `${book.title}（${book.author || '著者情報なし'}）を選択済み。`;
      });
    }

    resetSearchState();

    const reviews = [
      {
        id: generateId(),
        title: 'サピエンス全史',
        alias: 'anonymous',
        rating: 5,
        comment: '認知革命から貨幣・国家までを同じ視点で語る大胆さが好き。章ごとに止めても心がざわつく。',
        tags: ['#歴史', '#ノンフィクション'],
        comments: [
          { id: generateId('c'), alias: '灯台下暗し', text: '第2部の宗教パートだけ読み直しました。比喩が鮮烈。' }
        ]
      },
      {
        id: generateId(),
        title: '金閣寺',
        alias: 'midnight-reader',
        rating: 4,
        comment: '言葉の密度が高くて一段落ごとに息継ぎしたくなる。美に飲み込まれていく速度が異常。',
        tags: ['#日本文学', '#三島由紀夫'],
        comments: [
          { id: generateId('c'), alias: 'kyoto-walk', text: '終盤の独白、声に出すと余韻が長い。' }
        ]
      },
      {
        id: generateId(),
        title: '罪と罰',
        alias: '匿名読者',
        rating: 5,
        comment: '自責と救済のゆらめきが続くのに、警察パートは完全にスリラー。再読ベスト3入り確定。',
        tags: ['#ロシア文学', '#古典'],
        comments: []
      }
    ];

    function generateId(prefix = 'r') {
      return `${prefix}-${Math.random().toString(36).slice(2, 9)}`;
    }

    function updateRatingUI(value) {
      currentRating = value;
      ratingButtons.forEach((button, index) => {
        const isActive = index < value;
        button.classList.toggle('active', isActive);
      });
    }

    ratingButtons.forEach(button => {
      button.addEventListener('click', () => {
        const value = Number(button.dataset.ratingButton);
        updateRatingUI(value);
      });
    });

    function createStars(rating) {
      const stars = document.createElement('div');
      stars.className = 'stars';
      stars.setAttribute('aria-label', `評価 ${rating} / 5`);
      const fill = document.createElement('span');
      fill.style.setProperty('--fill', `${(rating / 5) * 100}%`);
      fill.textContent = '★★★★★';
      stars.appendChild(fill);
      stars.append('★★★★★');
      return stars;
    }

    function createTagElements(tags) {
      if (!tags || tags.length === 0) return null;
      const wrapper = document.createElement('div');
      wrapper.className = 'tags';
      tags.forEach(tag => {
        const chip = document.createElement('div');
        chip.className = 'tag';
        chip.textContent = tag;
        wrapper.appendChild(chip);
      });
      return wrapper;
    }

    function createCommentsSection(review) {
      const container = document.createElement('div');
      container.className = 'comments';

      const heading = document.createElement('h4');
      heading.textContent = 'コメント';
      container.appendChild(heading);

      const list = document.createElement('ul');
      list.className = 'comment-list';

      if (review.comments.length === 0) {
        const empty = document.createElement('li');
        const strong = document.createElement('strong');
        strong.textContent = 'まだコメントはありません';
        empty.appendChild(strong);
        const span = document.createElement('span');
        span.textContent = '最初のひと言を残しませんか？';
        empty.appendChild(span);
        list.appendChild(empty);
      } else {
        review.comments.forEach(comment => {
          const item = document.createElement('li');
          const strong = document.createElement('strong');
          strong.textContent = comment.alias || '匿名コメント';
          item.appendChild(strong);
          const span = document.createElement('span');
          span.textContent = comment.text;
          item.appendChild(span);
          list.appendChild(item);
        });
      }

      container.appendChild(list);

      const form = document.createElement('form');
      form.className = 'comment-form';
      form.dataset.reviewId = review.id;

      const aliasField = document.createElement('label');
      aliasField.innerHTML = '<span>名前 (任意)</span>';
      const aliasInput = document.createElement('input');
      aliasInput.type = 'text';
      aliasInput.name = 'comment-alias';
      aliasInput.placeholder = '匿名でもOK';
      aliasField.appendChild(aliasInput);

      const commentField = document.createElement('label');
      commentField.innerHTML = '<span>コメント *</span>';
      const commentTextarea = document.createElement('textarea');
      commentTextarea.name = 'comment-body';
      commentTextarea.required = true;
      commentTextarea.placeholder = 'レビューのどこに共感したかを書いてください';
      commentField.appendChild(commentTextarea);

      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.textContent = 'コメントを送信';

      form.append(aliasField, commentField, submitBtn);
      container.appendChild(form);

      return container;
    }

    function createReviewCard(review) {
      const article = document.createElement('article');
      article.className = 'review-card';

      const header = document.createElement('header');
      const heading = document.createElement('h3');
      heading.textContent = review.title;
      header.append(heading, createStars(review.rating));

      const alias = document.createElement('div');
      alias.className = 'alias';
      alias.textContent = review.alias || '匿名読者';

      const body = document.createElement('p');
      body.textContent = review.comment;

      article.append(header, alias, body);

      const tags = createTagElements(review.tags);
      if (tags) article.appendChild(tags);

      article.appendChild(createCommentsSection(review));
      return article;
    }

    function renderReviews() {
      feed.innerHTML = '';
      reviews.forEach(review => {
        feed.appendChild(createReviewCard(review));
      });
    }

    function createEmptyState(message) {
      const div = document.createElement('div');
      div.className = 'empty-state';
      div.textContent = message;
      return div;
    }

    function renderPersonalNote() {
      if (!noteDisplay) return;
      if (userNote.trim().length === 0) {
        noteDisplay.textContent = 'まだメモは登録されていません。今日の読書テーマを書き残してみませんか？';
        return;
      }
      noteDisplay.textContent = userNote;
    }

    function renderPersonalStats() {
      if (!statBoard) return;
      statBoard.innerHTML = '';
      if (personalStats.length === 0) {
        statBoard.appendChild(createEmptyState('指標がまだ登録されていません。お気に入りの追跡指標を追加しましょう。'));
        return;
      }
      personalStats.forEach(stat => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        const label = document.createElement('small');
        label.textContent = stat.label;
        const value = document.createElement('strong');
        value.textContent = stat.value;
        card.append(label, value);
        if (stat.note) {
          const note = document.createElement('span');
          note.textContent = stat.note;
          card.appendChild(note);
        }
        statBoard.appendChild(card);
      });
    }

    function renderPersonalShelves() {
      if (!shelfBoard) return;
      shelfBoard.innerHTML = '';
      if (personalShelves.length === 0) {
        shelfBoard.appendChild(createEmptyState('まだ本棚がありません。タイトルと冊数を入力して最初の棚を作成しましょう。'));
        return;
      }
      personalShelves.forEach(shelf => {
        const card = document.createElement('article');
        card.className = 'shelf-card';
        const heading = document.createElement('h3');
        heading.textContent = shelf.title;
        const progress = document.createElement('div');
        progress.className = 'shelf-progress';
        progress.setAttribute('aria-label', `進捗 ${shelf.percent}%`);
        const bar = document.createElement('span');
        bar.style.width = `${shelf.percent}%`;
        progress.appendChild(bar);
        const meta = document.createElement('div');
        meta.className = 'shelf-meta';
        meta.innerHTML = `<span>登録 ${shelf.total}冊</span><span>レビュー済み ${shelf.reviewed}冊</span>`;
        card.append(heading, progress, meta);
        if (shelf.note) {
          const note = document.createElement('p');
          note.className = 'shelf-note';
          note.textContent = shelf.note;
          card.appendChild(note);
        }
        shelfBoard.appendChild(card);
      });
    }

    function syncTabLabels(activeRadioId) {
      tabLabels.forEach(label => {
        const isActive = label.getAttribute('for') === activeRadioId;
        label.setAttribute('aria-selected', String(isActive));
      });
    }

    tabLabels.forEach(label => {
      label.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        const targetId = label.getAttribute('for');
        const targetRadio = document.getElementById(targetId);
        if (targetRadio) {
          targetRadio.checked = true;
          targetRadio.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    });

    tabRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.checked) {
          syncTabLabels(radio.id);
        }
      });
    });

    if (tagAddButton && tagCustomInput) {
      tagAddButton.addEventListener('click', () => {
        const value = tagCustomInput.value.trim();
        if (!value) return;
        addCustomTag(value);
        tagCustomInput.value = '';
      });
      tagCustomInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          const value = tagCustomInput.value.trim();
          if (!value) return;
          addCustomTag(value);
          tagCustomInput.value = '';
        }
      });
    }

    if (tagClearButton) {
      tagClearButton.addEventListener('click', () => {
        selectedTags = [];
        renderSelectedTags();
      });
    }

    if (feed) {
      feed.addEventListener('submit', (event) => {
        if (!event.target.classList.contains('comment-form')) return;
        event.preventDefault();
        const formEl = event.target;
        const reviewId = formEl.dataset.reviewId;
        const alias = formEl.querySelector('[name="comment-alias"]').value.trim();
        const text = formEl.querySelector('[name="comment-body"]').value.trim();

        if (!text) return;

        const targetReview = reviews.find(r => r.id === reviewId);
        if (!targetReview) return;

        targetReview.comments.unshift({
          id: generateId('c'),
          alias,
          text
        });

        renderReviews();
      });
    }

    if (form) {
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const title = form.querySelector('#book-title').value.trim();
        const alias = form.querySelector('#book-alias').value.trim();
        const comment = form.querySelector('#book-comment').value.trim();

        if (!title || !comment || currentRating === 0) {
          statusEl.textContent = 'タイトル、コメント、星評価は必須です。';
          return;
        }

        if (!selectedBook || selectedBook.title !== title) {
          statusEl.textContent = '検索候補から書名を選択して確定してください。';
          return;
        }

        const normalizedIsbn = (selectedBook.id || '')
          .replace(/[^0-9Xx]/g, '')
          .slice(0, 13);
        const isbnTag = normalizedIsbn ? `#ISBN:${normalizedIsbn}` : '#ISBN:UNKNOWN';
        const reviewTags = [
          ...selectedTags,
          isbnTag,
          '#ユーザー投稿'
        ];

        reviews.unshift({
          id: generateId(),
          title,
          alias,
          rating: currentRating,
          comment,
          tags: reviewTags,
          comments: []
        });

        renderReviews();

        form.reset();
        updateRatingUI(0);
        resetSearchState();
        selectedTags = [];
        suggestedTags = [];
        renderSelectedTags();
        renderTagSuggestions();
        statusEl.textContent = '投稿しました。確認後に公開されます。';
        setTimeout(() => (statusEl.textContent = ''), 2500);
      });
    }

    function setIdeaPanel(open) {
      if (!ideaPanel || !ideaToggle) return;
      ideaPanel.toggleAttribute('hidden', !open);
      ideaToggle.setAttribute('aria-expanded', String(open));
    }

    if (ideaToggle) {
      ideaToggle.addEventListener('click', () => {
        const isOpen = ideaToggle.getAttribute('aria-expanded') === 'true';
        setIdeaPanel(!isOpen);
      });
    }

    document.addEventListener('click', (event) => {
      if (!ideaPanel || ideaPanel.hasAttribute('hidden')) return;
      if (ideaPanel.contains(event.target) || ideaToggle.contains(event.target)) return;
      setIdeaPanel(false);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        setIdeaPanel(false);
      }
    });

    if (noteForm) {
      noteForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const text = noteForm.querySelector('#note-input').value.trim();
        userNote = text;
        renderPersonalNote();
        noteForm.reset();
        if (noteStatus) {
          noteStatus.textContent = text ? 'メモを更新しました。' : 'メモを空にしました。';
          setTimeout(() => (noteStatus.textContent = ''), 2000);
        }
      });
    }

    if (statForm) {
      statForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const labelInput = statForm.querySelector('#stat-label');
        const valueInput = statForm.querySelector('#stat-value');
        const noteInput = statForm.querySelector('#stat-note');
        const label = labelInput.value.trim();
        const value = valueInput.value.trim();
        if (!label || value === '') {
          if (statStatus) statStatus.textContent = '指標タイトルと値は必須です。';
          return;
        }
        const entry = {
          id: generateId('stat'),
          label,
          value,
          note: noteInput.value.trim()
        };
        personalStats.unshift(entry);
        renderPersonalStats();
        statForm.reset();
        if (statStatus) {
          statStatus.textContent = '指標を追加しました。';
          setTimeout(() => (statStatus.textContent = ''), 2000);
        }
      });
    }

    if (shelfForm) {
      shelfForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const title = shelfForm.querySelector('#shelf-title').value.trim();
        const total = Number(shelfForm.querySelector('#shelf-total').value);
        const reviewed = Number(shelfForm.querySelector('#shelf-reviewed').value);
        const note = shelfForm.querySelector('#shelf-note').value.trim();
        if (!title || Number.isNaN(total) || Number.isNaN(reviewed)) {
          if (shelfStatus) shelfStatus.textContent = '本棚タイトルと冊数を入力してください。';
          return;
        }
        const safeTotal = Math.max(total, 0);
        const safeReviewed = Math.min(Math.max(reviewed, 0), safeTotal);
        const percent = safeTotal === 0 ? 0 : Math.min(100, Math.round((safeReviewed / safeTotal) * 100));
        personalShelves.unshift({
          id: generateId('shelf'),
          title,
          total: safeTotal,
          reviewed: safeReviewed,
          percent,
          note
        });
        renderPersonalShelves();
        shelfForm.reset();
        if (shelfStatus) {
          shelfStatus.textContent = '本棚を追加しました。';
          setTimeout(() => (shelfStatus.textContent = ''), 2000);
        }
      });
    }

    const footerYear = document.getElementById('footer-year');
    if (footerYear) {
      footerYear.textContent = new Date().getFullYear();
    }

    syncTabLabels('tab-sns-control');
    setIdeaPanel(false);
    renderReviews();
    renderPersonalNote();
    renderPersonalStats();
    renderPersonalShelves();
    renderSelectedTags();

    function addCustomTag(tag) {
      const normalized = tag.startsWith('#') ? tag : `#${tag}`;
      if (!selectedTags.includes(normalized)) {
        selectedTags.push(normalized);
        renderSelectedTags();
      }
    }
  </script>
</body>
</html>
